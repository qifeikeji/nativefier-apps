name: ci

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    strategy:
      matrix:
        os: [ubuntu-latest]
    runs-on: ${{ matrix.os }}
    steps:
      - name: Check out Git repository
        uses: actions/checkout@v1

      - name: Install Node.js, NPM and Yarn
        uses: actions/setup-node@v1
        with:
          node-version: 14

      - name: Build apps
        shell: bash
        env:
          APPS: |
            [
              {"url": "https://www.kaiheila.cn/", "name": "开黑啦"},
              {"url": "https://www.inoreader.com", "name": "Inoreader"},
              {"url": "https://flomoapp.com/", "name": "flomo"}
            ]
        run: |
          npm install -g nativefier
          ELECTRON_VERSION="30.0.0"
          echo "$APPS" | jq -r '.[] | [.url, .name] | join(" ")' | while read url name; do
            echo "Building $name for Linux x64..."
            nativefier "$url" \
              --name "$name" \
              --electron-version "$ELECTRON_VERSION" \
              --platform linux \
              --arch x64 \
              --portable \
              --proxy-rules "http://192.168.1.1:8118" \
              --internal-urls "^_$"
            zip -r "${name}_linux_x64.zip" *linux-x64
            rm -rf *linux-x64/
          done

      - name: Upload artifacts
        uses: actions/upload-artifact@v2
        with:
          name: linux-builds
          path: |
            开黑啦_linux_x64.zip
            Inoreader_linux_x64.zip
            flomo_linux_x64.zip
