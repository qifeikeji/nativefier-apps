name: ci
on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

env:
  # é…ç½®éœ€è¦æž„å»ºçš„ç½‘ç«™
  SITES: |
    gmail|https://mail.google.com/mail/u/0/#inbox
    github|https://github.com
    chatgpt|https://chat.openai.com
    xai|https://grok.com/chat
    protonmail|https://mail.proton.me
    douyutv|https://www.douyu.com/directory/myFollow
    youtube|https://www.youtube.com

jobs:
  build:
    strategy:
      matrix:
        os: [ubuntu-latest]
    runs-on: ${{ matrix.os }}
    steps:
      - name: Check out Git repository
        uses: actions/checkout@v4

      - name: Install Node.js and NPM
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Get latest stable Electron version
        id: electron
        run: |
          ELECTRON_VERSION=$(npm view electron version)
          echo "version=$ELECTRON_VERSION" >> $GITHUB_OUTPUT
          echo "âœ… Latest stable Electron version: $ELECTRON_VERSION"

      - name: Install Nativefier
        run: npm install -g nativefier

      - name: Create injection script
        run: |
          cat << 'EOF' > inject.js
          const { app } = require('electron');
          window.addEventListener('DOMContentLoaded', () => {
            const electronVersion = process.versions.electron;
            const originalTitle = document.title;
            document.title = `${originalTitle} - Electron v${electronVersion}`;
          });
          EOF

      - name: Build applications
        env:
          ELECTRON_VERSION: ${{ steps.electron.outputs.version }}
        run: |
          echo "ðŸš€ Building applications with Electron v$ELECTRON_VERSION"
          echo ""
          
          # è§£æžé…ç½®å¹¶æž„å»ºæ¯ä¸ªåº”ç”¨
          echo "$SITES" | grep -v '^[[:space:]]*$' | while IFS='|' read -r name url; do
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ðŸ“¦ Building: $name"
            echo "ðŸŒ URL: $url"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            
            nativefier "$url" \
              --name "$name" \
              --electron-version "$ELECTRON_VERSION" \
              --platform linux \
              --arch x64 \
              --portable \
              --internal-urls ".*" \
              --inject inject.js \
              --verbose
            
            # æŸ¥æ‰¾ç”Ÿæˆçš„ç›®å½•å¹¶åŽ‹ç¼©
            app_dir=$(find . -maxdepth 1 -type d -name "${name}*linux-x64" | head -n 1)
            
            if [ -n "$app_dir" ]; then
              zip_name="${name}_linux_x64.zip"
              echo "ðŸ“¦ Packaging: $zip_name"
              zip -r "$zip_name" "$app_dir"
              rm -rf "$app_dir"
              echo "âœ… Successfully built: $zip_name"
            else
              echo "âŒ Failed to find build directory for $name"
            fi
            
            echo ""
          done
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ¨ All builds completed!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          ls -lh *.zip

      - name: Upload artifacts
        env:
          ELECTRON_VERSION: ${{ steps.electron.outputs.version }}
        run: |
          echo "ðŸ“¤ Uploading individual artifacts..."
          echo ""
          
          # ä¸ºæ¯ä¸ª ZIP æ–‡ä»¶åˆ›å»ºæ ‡è®°æ–‡ä»¶
          for zip_file in *.zip; do
            if [ -f "$zip_file" ]; then
              base_name="${zip_file%.zip}"
              echo "${base_name}_electron-v${ELECTRON_VERSION}" > "${zip_file}.artifact_name"
            fi
          done

      - name: Upload Gmail
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: gmail_linux_x64_electron-v${{ steps.electron.outputs.version }}
          path: gmail_linux_x64.zip
          if-no-files-found: warn

      - name: Upload GitHub
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: github_linux_x64_electron-v${{ steps.electron.outputs.version }}
          path: github_linux_x64.zip
          if-no-files-found: warn

      - name: Upload ChatGPT
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: chatgpt_linux_x64_electron-v${{ steps.electron.outputs.version }}
          path: chatgpt_linux_x64.zip
          if-no-files-found: warn

      - name: Upload XAI
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: xai_linux_x64_electron-v${{ steps.electron.outputs.version }}
          path: xai_linux_x64.zip
          if-no-files-found: warn

      - name: Upload ProtonMail
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: protonmail_linux_x64_electron-v${{ steps.electron.outputs.version }}
          path: protonmail_linux_x64.zip
          if-no-files-found: warn

      - name: Upload DouyuTV
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: douyutv_linux_x64_electron-v${{ steps.electron.outputs.version }}
          path: douyutv_linux_x64.zip
          if-no-files-found: warn

      - name: Upload YouTube
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: youtube_linux_x64_electron-v${{ steps.electron.outputs.version }}
          path: youtube_linux_x64.zip
          if-no-files-found: warn
