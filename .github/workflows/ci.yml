name: ci

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    strategy:
      matrix:
        os: [ubuntu-latest]
    runs-on: ${{ matrix.os }}
    steps:
      - name: Check out Git repository
        uses: actions/checkout@v1

      - name: Install Node.js, NPM and Yarn
        uses: actions/setup-node@v1
        with:
          node-version: 18

      - name: Build apps
        shell: bash
        env:
          APPS: |
            [
              {"url": "https://www.kaiheila.cn/", "name": "开黑啦"},
              {"url": "https://www.inoreader.com", "name": "Inoreader"},
              {"url": "https://flomoapp.com/", "name": "flomo"}
            ]
        run: |
          npm install -g nativefier
          ELECTRON_VERSION="30.0.0"
          echo "Using Electron version: $ELECTRON_VERSION"
          touch zip_files.txt
          cat << 'EOF' > inject.js
          const { app, Menu } = require('electron');
          window.addEventListener('DOMContentLoaded', () => {
            const template = [
              {
                label: 'About',
                click: () => {
                  const version = process.versions.electron;
                  alert(`This app is powered by Electron v${version}`);
                }
              }
            ];
            const menu = Menu.buildFromTemplate(template);
            Menu.setApplicationMenu(menu);
          });
          EOF
          echo "$APPS" | jq -r '.[] | [.url, .name] | join(" ")' | while read url name; do
            echo "Building $name for Linux x64..."
            nativefier "$url" \
              --name "$name" \
              --electron-version "$ELECTRON_VERSION" \
              --platform linux \
              --arch x64 \
              --portable \
              --proxy-rules "http://192.168.1.1:8118" \
              --internal-urls "^_$" \
              --inject inject.js
            zip -r "${name}_linux_x64.zip" *linux-x64
            echo "${name}_linux_x64.zip" >> zip_files.txt
            rm -rf *linux-x64/
          done
          # 直接将 zip_files.txt 的内容作为多行输出，而不是单行字符串
          echo "ZIP_FILES<<EOF" >> $GITHUB_ENV
          cat zip_files.txt >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-builds
          path: ${{ env.ZIP_FILES }}
