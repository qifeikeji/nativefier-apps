name: ci
on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

env:
  # é…ç½®éœ€è¦æž„å»ºçš„ç½‘ç«™
  SITES: |
    gmail|https://mail.google.com/mail/u/0/#inbox
    github|https://github.com
    chatgpt|https://chat.openai.com
    xai|https://grok.com/chat
    protonmail|https://mail.proton.me
    douyutv|https://www.douyu.com/directory/myFollow
    youtube|https://www.youtube.com

jobs:
  build:
    strategy:
      matrix:
        os: [ubuntu-latest]
    runs-on: ${{ matrix.os }}
    steps:
      - name: Check out Git repository
        uses: actions/checkout@v4

      - name: Install Node.js and NPM
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Get latest stable Electron version
        id: electron
        run: |
          ELECTRON_VERSION=$(npm view electron version)
          echo "version=$ELECTRON_VERSION" >> $GITHUB_OUTPUT
          echo "âœ… Latest stable Electron version: $ELECTRON_VERSION"

      - name: Install Nativefier
        run: npm install -g nativefier

      - name: Create injection script
        run: |
          cat << 'EOF' > inject.js
          // æ³¨æ„ï¼šè¯¥è„šæœ¬è¿è¡Œåœ¨ç½‘é¡µä¸Šä¸‹æ–‡ï¼ˆrendererï¼‰é‡Œï¼Œä¸ä¿è¯èƒ½ require('electron')ã€‚
          // è¿™é‡Œä¿æŒâ€œé›¶ä¾µå…¥â€ï¼Œé¿å…ç ´å Cloudflare / ç™»å½•é¡µç­‰å…³é”®è„šæœ¬ã€‚
          window.addEventListener('DOMContentLoaded', () => {
            // no-op (reserved for future safe tweaks)
          });
          EOF

      - name: Build applications
        env:
          ELECTRON_VERSION: ${{ steps.electron.outputs.version }}
          # ä¸ºäº†å…¼å®¹ Cloudflare ç­‰é£ŽæŽ§ç»„ä»¶ï¼Œç»Ÿä¸€ä½¿ç”¨æ›´æ ‡å‡†çš„æµè§ˆå™¨ UAï¼ˆé¿å… Electron/Nativefier æ ‡è¯†å¯¼è‡´è¯¯åˆ¤ï¼‰
          USER_AGENT: Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36
        run: |
          echo "ðŸš€ Building applications with Electron v$ELECTRON_VERSION"
          echo ""
          
          # å…¼å®¹ä¸åŒ nativefier ç‰ˆæœ¬çš„ UA å‚æ•°ï¼ˆéƒ¨åˆ†ç‰ˆæœ¬å‚æ•°åå¯èƒ½ä¸åŒï¼‰
          UA_FLAG="--user-agent"
          if ! nativefier --help 2>/dev/null | grep -q -- "--user-agent"; then
            if nativefier --help 2>/dev/null | grep -q -- "--ua"; then
              UA_FLAG="--ua"
            else
              echo "âš ï¸ nativefier does not advertise a UA flag; continuing without forcing USER_AGENT"
              UA_FLAG=""
            fi
          fi
          
          # è§£æžé…ç½®å¹¶æž„å»ºæ¯ä¸ªåº”ç”¨
          echo "$SITES" | grep -v '^[[:space:]]*$' | while IFS='|' read -r name url; do
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ðŸ“¦ Building: $name"
            echo "ðŸŒ URL: $url"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            
            nativefier "$url" \
              --name "$name" \
              --electron-version "$ELECTRON_VERSION" \
              --platform linux \
              --arch x64 \
              --portable \
              --internal-urls ".*" \
              ${UA_FLAG:+$UA_FLAG "$USER_AGENT"} \
              --inject inject.js \
              --verbose
            
            # æŸ¥æ‰¾ç”Ÿæˆçš„ç›®å½•å¹¶åŽ‹ç¼©
            app_dir=$(find . -maxdepth 1 -type d -name "${name}*linux-x64" | head -n 1)
            
            if [ -n "$app_dir" ]; then
              zip_name="${name}_linux_x64.zip"
              echo "ðŸ“¦ Packaging: $zip_name"
              zip -r "$zip_name" "$app_dir"
              rm -rf "$app_dir"
              echo "âœ… Successfully built: $zip_name"
            else
              echo "âŒ Failed to find build directory for $name"
            fi
            
            echo ""
          done
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ¨ All builds completed!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          ls -lh *.zip

      - name: Prepare release tag
        if: github.event_name != 'pull_request'
        id: release_meta
        env:
          ELECTRON_VERSION: ${{ steps.electron.outputs.version }}
        run: |
          if [ "${GITHUB_REF_TYPE:-}" = "tag" ] && [ -n "${GITHUB_REF_NAME:-}" ]; then
            TAG_NAME="${GITHUB_REF_NAME}"
          else
            TAG_NAME="electron-v${ELECTRON_VERSION}-run${GITHUB_RUN_NUMBER}"
          fi
          RELEASE_NAME="Nativefier Apps (${TAG_NAME})"
          echo "tag_name=$TAG_NAME" >> "$GITHUB_OUTPUT"
          echo "release_name=$RELEASE_NAME" >> "$GITHUB_OUTPUT"
          echo "âœ… Release: $RELEASE_NAME"

      - name: Create/Update GitHub Release and upload zips
        if: github.event_name != 'pull_request'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.release_meta.outputs.tag_name }}
          name: ${{ steps.release_meta.outputs.release_name }}
          files: "*.zip"
          fail_on_unmatched_files: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload artifacts
        env:
          ELECTRON_VERSION: ${{ steps.electron.outputs.version }}
        run: |
          echo "ðŸ“¤ Uploading individual artifacts..."
          echo ""
          
          # ä¸ºæ¯ä¸ª ZIP æ–‡ä»¶åˆ›å»ºæ ‡è®°æ–‡ä»¶
          for zip_file in *.zip; do
            if [ -f "$zip_file" ]; then
              base_name="${zip_file%.zip}"
              echo "${base_name}_electron-v${ELECTRON_VERSION}" > "${zip_file}.artifact_name"
            fi
          done

      - name: Upload Gmail
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: gmail_linux_x64_electron-v${{ steps.electron.outputs.version }}
          path: gmail_linux_x64.zip
          if-no-files-found: warn

      - name: Upload GitHub
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: github_linux_x64_electron-v${{ steps.electron.outputs.version }}
          path: github_linux_x64.zip
          if-no-files-found: warn

      - name: Upload ChatGPT
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: chatgpt_linux_x64_electron-v${{ steps.electron.outputs.version }}
          path: chatgpt_linux_x64.zip
          if-no-files-found: warn

      - name: Upload XAI
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: xai_linux_x64_electron-v${{ steps.electron.outputs.version }}
          path: xai_linux_x64.zip
          if-no-files-found: warn

      - name: Upload ProtonMail
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: protonmail_linux_x64_electron-v${{ steps.electron.outputs.version }}
          path: protonmail_linux_x64.zip
          if-no-files-found: warn

      - name: Upload DouyuTV
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: douyutv_linux_x64_electron-v${{ steps.electron.outputs.version }}
          path: douyutv_linux_x64.zip
          if-no-files-found: warn

      - name: Upload YouTube
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: youtube_linux_x64_electron-v${{ steps.electron.outputs.version }}
          path: youtube_linux_x64.zip
          if-no-files-found: warn
